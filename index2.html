<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hydroponic Controller Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container { padding-top: 50px; }
    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2); }
    .card-title { color: #333; font-weight: 600; }
    .status { font-weight: bold; margin-top: 10px; }
    .status.on { color: #28a745; }
    .status.off { color: #dc3545; }
    h1 { color: white; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); margin-bottom: 40px; }
    .icon { font-size: 2rem; margin-bottom: 15px; color: #667eea; }

    /* Tangki air */
    .tank {
      position: relative;
      width: 70px;
      height: 130px;
      border: 3px solid #333;
      border-radius: 8px;
      margin: 10px auto;
      background: rgba(255, 255, 255, 0.6);
      overflow: hidden;
    }
    .water {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: linear-gradient(to top, #007bff, #00bfff);
      transition: height 0.8s ease, background 0.8s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center">Hydroponic Controller Dashboard</h1>

    <!-- Tanggal dan waktu -->
    <div class="row justify-content-center mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body text-center">
            <i class="fas fa-clock icon"></i>
            <h5 class="card-title">Tanggal & Waktu</h5>
            <p class="status" id="datetime">--</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Pompa -->
    <div class="row justify-content-center">
      <div class="col-lg-4 col-md-6 mb-4">
        <div class="card h-100">
          <div class="card-body text-center d-flex flex-column justify-content-center">
            <i class="fas fa-plus-circle icon"></i>
            <h5 class="card-title">Water Pump</h5>
            <div class="form-check form-switch d-flex justify-content-center">
              <input class="form-check-input" type="checkbox" id="pump-b">
            </div>
            <p class="status off" id="status-b">Off</p>
          </div>
        </div>
      </div>

      <div class="col-lg-4 col-md-6 mb-4">
        <div class="card h-100">
          <div class="card-body text-center d-flex flex-column justify-content-center">
            <i class="fas fa-tint icon"></i>
            <h5 class="card-title">Add Nutrition Pump</h5>
            <div class="form-check form-switch d-flex justify-content-center">
              <input class="form-check-input" type="checkbox" id="pump-c">
            </div>
            <p class="status off" id="status-c">Off</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Sensor -->
    <div class="row justify-content-center">
      <div class="col-lg-4 col-md-6 mb-4">
        <div class="card h-100">
          <div class="card-body text-center d-flex flex-column justify-content-center">
            <i class="fas fa-thermometer-half icon"></i>
            <h5 class="card-title">Temperature</h5>
            <p class="status" id="temp-value">-- °C</p>
          </div>
        </div>
      </div>

      <div class="col-lg-4 col-md-6 mb-4">
        <div class="card h-100">
          <div class="card-body text-center d-flex flex-column justify-content-center">
            <i class="fas fa-water icon"></i>
            <h5 class="card-title">Humidity</h5>
            <p class="status" id="hum-value">-- %</p>
          </div>
        </div>
      </div>

      <div class="col-lg-4 col-md-6 mb-4">
        <div class="card h-100">
          <div class="card-body text-center d-flex flex-column justify-content-center">
            <i class="fas fa-gauge icon"></i>
            <h5 class="card-title">Water Level</h5>
            <div class="tank">
              <div class="water" id="water-fill"></div>
            </div>
            <p class="status" id="water-level-value">-- %</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Script -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
  <script>
    // Koneksi ke broker MQTT (sama dengan ESP8266)
    const brokerUrl = 'ws://broker.hivemq.com:8000/mqtt';
    const clientId = 'hydroponic-dashboard-' + Math.random().toString(16).substr(2, 8);
    const client = mqtt.connect(brokerUrl, { clientId });

    const topics = {
      pumpB: 'pumpB',
      pumpC: 'pumpC',
      dataTemp: 'dataTemp',
      dataHum: 'dataHum',
      dataWaterLevel: 'dataWaterLevel'
    };

    client.on('connect', function () {
      console.log('✅ Connected to MQTT broker');
      Object.values(topics).forEach(topic => {
        client.subscribe(topic, err => {
          if (!err) console.log('Subscribed to ' + topic);
        });
      });
    });

    client.on('message', function (topic, message) {
      const payload = message.toString();

      if (topic === topics.pumpB) updatePumpStatus('pump-b', 'status-b', payload);
      else if (topic === topics.pumpC) updatePumpStatus('pump-c', 'status-c', payload);
      else if (topic === topics.dataTemp)
        document.getElementById('temp-value').textContent = payload + ' °C';
      else if (topic === topics.dataHum)
        document.getElementById('hum-value').textContent = payload + ' %';
      else if (topic === topics.dataWaterLevel) updateWaterLevel(payload);
    });

    function updatePumpStatus(checkboxId, statusId, payload) {
      const checkbox = document.getElementById(checkboxId);
      const status = document.getElementById(statusId);
      const isOn = payload === '1';
      checkbox.checked = isOn;
      status.textContent = isOn ? 'On' : 'Off';
      status.className = 'status ' + (isOn ? 'on' : 'off');
    }

    // Fungsi ubah warna & tinggi air
    function updateWaterLevel(cmValue) {
      const cm = parseInt(cmValue);
      const tankHeight =  20; // cm sesuai di ESP
      let percent = (cm / tankHeight) * 100;
      if (percent > 100) percent = 100;
      if (percent < 0) percent = 0;

      const waterDiv = document.getElementById('water-fill');
      const waterText = document.getElementById('water-level-value');
      waterText.textContent = percent.toFixed(0) + ' %';

      // Ubah warna berdasarkan level
      if (percent >= 70) {
        waterDiv.style.background = 'linear-gradient(to top, #007bff, #00bfff)'; // biru penuh
      } else if (percent >= 40) {
        waterDiv.style.background = 'linear-gradient(to top, #ffc107, #ffeb3b)'; // kuning waspada
      } else {
        waterDiv.style.background = 'linear-gradient(to top, #dc3545, #ff6b6b)'; // merah bahaya
      }

      // Atur tinggi air
      waterDiv.style.height = percent + '%';
    }

    function updateStatus(id, statusId, topic) {
      const checkbox = document.getElementById(id);
      const status = document.getElementById(statusId);
      checkbox.addEventListener('change', function() {
        const isOn = this.checked;
        status.textContent = isOn ? 'On' : 'Off';
        status.className = 'status ' + (isOn ? 'on' : 'off');
        client.publish(topic, isOn ? '1' : '0');
      });
    }

    updateStatus('pump-b', 'status-b', topics.pumpB);
    updateStatus('pump-c', 'status-c', topics.pumpC);

    // Jam Indonesia
    const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
    function updateDateTime() {
      const now = new Date();
      const day = days[now.getDay()];
      const date = now.toLocaleDateString('id-ID');
      const time = now.toLocaleTimeString('id-ID');
      document.getElementById('datetime').textContent = `${day}, ${date} ${time}`;
    }
    updateDateTime();
    setInterval(updateDateTime, 1000);
  </script>
</body>
</html>
